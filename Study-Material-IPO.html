<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Materials - IPO</title>

<style>
body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #f4f6fb;
}
header {
    background: linear-gradient(135deg, #ffec99, #ffd54f);
    padding: 12px 16px 14px;
}
.header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.logo-box img {
    height: 45px;
}
.caption {
    font-size: 18px;
    font-weight: 600;
    color: #5a4300;
}
.user-info {
    font-size: 13px;
    text-align: right;
    font-weight: bold;
    color: #5a4300;
}
#welcome {
    text-align: center;
    margin: 10px 0;
    font-size: 20px;
    color: #5a4300;
}
.container {
    display: flex;
    height: calc(100vh - 120px);
}
.left {
    width: 25%;
    background: linear-gradient(180deg, #fff3b0, #ffe082);
    padding: 30px 14px;
    overflow-y: auto;
    position: relative;
}
.paper {
    margin-bottom: 14px;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,.12);
}
.paper-header {
    background: #0056d2;
    color: #fff;
    padding: 14px;
    font-size: 15px;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
}
.paper.active .paper-header {
    background: #003f9e;
}
.paper-content {
    display: none;
    background: #f9fbff;
}
.topic {
    padding: 12px 14px;
    border-bottom: 1px solid #e0e6f5;
    cursor: pointer;
    font-size: 14px;
}
.topic:hover {
    background: #eef3ff;
}
.back-btn {
    margin-top: 80px;
    display: block;
    text-align: center;
    padding: 12px;
    background: #0056d2;
    color: #fff;
    border-radius: 10px;
    text-decoration: none;
}
.right {
    width: 75%;
    padding: 20px;
    position: relative;
}
iframe {
    width: 100%;
    height: 72vh;
    border: none;
    border-radius: 10px;
    box-shadow: 0 6px 20px rgba(0,0,0,.12);
}
.download {
    display: inline-block;
    margin-bottom: 10px;
    padding: 8px 14px;
    background: #0056d2;
    color: #fff;
    border-radius: 6px;
    text-decoration: none;
}

/* ===== SPINNERS ===== */
.panel-loader {
    position: absolute;
    inset: 0;
    background: rgba(255,255,255,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10;
}
.panel-loader.hidden {
    display: none;
}
.spinner {
    width: 42px;
    height: 42px;
    border: 5px solid #ddd;
    border-top: 5px solid #0056d2;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}
@keyframes spin {
    to { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .container { flex-direction: column; }
    .left, .right { width: 100%; }
}
</style>
</head>

<body>

<header>
    <div class="header-top">
        <div class="logo-box">
            <img src="logo.png">
            <div class="caption">POAdda ‚Äì A journey towards excellence</div>
        </div>
        <div class="user-info" id="userInfo"></div>
    </div>
    <h2 id="welcome">Welcome to the IPO Study Materials üëã</h2>
</header>

<div class="container">
    <div class="left" id="paperList">

        <!-- LEFT PANEL LOADER -->
        <div id="leftLoader" class="panel-loader">
            <div class="spinner"></div>
        </div>

        <a href="dash.html" class="back-btn">‚Üê Back to Profile</a>
    </div>

    <div class="right">
        <h3 id="pdfTitle">Select a chapter</h3>

        <!-- RIGHT PANEL LOADER -->
        <div id="pdfLoader" class="panel-loader hidden">
            <div class="spinner"></div>
        </div>

        <div id="pdfSection" style="display:none;">
            <a id="downloadBtn" class="download" download>Download PDF</a>
            <iframe id="pdfViewer"></iframe>
        </div>
    </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxolCWXg1g6JGNDdVvfKOvQXdmBikm_9Wp8Sk1MoROcCdx1IguNiPaWGU7kDx7-SIg0/exec";

const leftLoader = document.getElementById("leftLoader");
const pdfLoader = document.getElementById("pdfLoader");
const pdfViewer = document.getElementById("pdfViewer");
const pdfSection = document.getElementById("pdfSection");
const downloadBtn = document.getElementById("downloadBtn");

/* USER INFO */
(() => {
    const p = new URLSearchParams(location.search);
    if (p.get("name") && p.get("mobile")) {
        localStorage.setItem("userName", p.get("name"));
        localStorage.setItem("userMobile", p.get("mobile"));
    }
    document.getElementById("userInfo").innerHTML =
        `${localStorage.getItem("userName") || "Student"}<br>
         ${localStorage.getItem("userMobile") || ""}`;
})();

/* LOAD CHAPTERS */
fetch(SCRIPT_URL)
.then(r => r.json())
.then(r => {
    leftLoader.classList.add("hidden");

    const data = r.data;
    const columns = [
        { chapter: 0, pdf: 1 },
        { chapter: 2, pdf: 3 },
        { chapter: 4, pdf: 5 }
    ];

    columns.forEach(col => {
        const cardTitle = data[0][col.chapter];
        if (!cardTitle) return;

        const paper = document.createElement("div");
        paper.className = "paper";

        const header = document.createElement("div");
        header.className = "paper-header";
        header.innerHTML = `<span>${cardTitle}</span><span>+</span>`;

        const content = document.createElement("div");
        content.className = "paper-content";

        header.onclick = () => {
            const open = paper.classList.contains("active");
            document.querySelectorAll(".paper").forEach(p => {
                p.classList.remove("active");
                p.querySelector(".paper-content").style.display = "none";
                p.querySelector(".paper-header span:last-child").innerText = "+";
            });
            if (!open) {
                paper.classList.add("active");
                content.style.display = "block";
                header.querySelector("span:last-child").innerText = "‚àí";
            }
        };

        for (let i = 1; i < data.length; i++) {
            const name = data[i][col.chapter];
            const link = data[i][col.pdf];
            if (name) {
                const t = document.createElement("div");
                t.className = "topic";
                t.innerText = name;
                if (link) t.onclick = () => openPDF(link);
                content.appendChild(t);
            }
        }

        paper.append(header, content);
        paperList.insertBefore(paper, document.querySelector(".back-btn"));
    });
})
.catch(() => {
    leftLoader.classList.add("hidden");
    alert("Failed to load chapters");
});

/* OPEN PDF WITH LOADER */
function openPDF(value) {
    let fileId = value.trim();

    if (fileId.includes("drive.google.com")) {
        let m = fileId.match(/\/d\/([^\/]+)/);
        if (m && m[1]) fileId = m[1];
        else if (fileId.includes("id="))
            fileId = fileId.split("id=")[1].split("&")[0];
    }

    pdfSection.style.display = "block";
    pdfLoader.classList.remove("hidden");

    pdfViewer.onload = () => pdfLoader.classList.add("hidden");

    pdfViewer.src = `https://drive.google.com/file/d/${fileId}/preview`;
    downloadBtn.href = `https://drive.google.com/file/d/${fileId}/view`;
}
</script>

</body>
</html>
